"""BTC Puzzle 135: Why Do Some k Values Produce Near-Collisions?
On every iteration, improve priority_v1 over the priority_vX methods from previous iterations.

THE MYSTERY:
When running Pollard's Kangaroo on puzzle 135, we observe that certain 
k_est values (computed from near-collisions between tame and wild DPs) 
have dramatically different gap sizes. Some gaps are as low as 1.5, 
others are 10^26. That's 26 orders of magnitude difference!

The low-gap k values are NOT random. Something about these specific 
integers makes the tame kangaroos land extremely close to wild ones.
The wild kangaroos are influenced by the public key. So what property 
of these k values makes them "attract" near-collisions?

PUZZLE 135 KEYSPACE:
  Range: 0x4000000000000000000000000000000000 to 0x7FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF (135 bits)  
  PubKey: 02145d2611c823a396ef6712ce0f712f09b9b4f3135e3e0aa3230fb9b6d08d1e16
  Curve order N: 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141

YOUR MISSION:
Discover what makes low-gap k values special. This is open exploration.

DIRECTIONS TO EXPLORE (non-exhaustive):
- Modular arithmetic (mod small primes, mod curve order N, CRT)
- Bit patterns (popcount, runs, transitions, density, palindromes)
- Hex patterns (nibble distributions, repeated sequences, symmetry)
- Algebraic properties (smoothness, quadratic residues, Legendre symbol)
- Relationships (k vs chunk_start, k vs range boundaries, k vs N)
- ECC geometry (how k*G relates to wild kangaroo paths on curve)
- Number theory (continued fractions, convergents, Farey sequences)
- Dynamical systems (orbits, fixed points, attractors in the walk)
- Information theory (entropy, compressibility, Kolmogorov complexity)
- Spectral analysis (Fourier intuition, periodicity, harmonics)
- Topology (shape of the data, clustering, manifold structure)
- Statistical patterns (distribution tails, outlier structure)

The answer could be simple or profound. Find it.
"""

import funsearch

# LOW GAP DATA: k_est values that produced near-collisions (lgap < 220)
# Format: (lgap, k_est_hex, chunk_start_hex)
LOW_GAP = [
    (1.5, "609474AA04271A2F70AE6C634142976DB1", "609474AA04271A2F700000000000000000"),
    (2.1, "56F20B20021EBCECB5000000007D6674CB", "56F20B20021EBCECB50000000000000000"),
    (5.8, "5D90FD9D5AF04D31EBEFE46C8E2BB573C3", "5D90FD9D5AF04D31EB0000000000000000"),
    (10.3, "57A59B74D0B359F34A6C3A3BA7BCBFF16A", "57A59B74D0B359F34A0000000000000000"),
    (10.4, "4C9A0CFD6D9C09EB529807971117507026", "4C9A0CFD6D9C09EB520000000000000000"),
    (13.6, "4AA11E389054C5A9A0FFFFFFFCD45715E5", "4AA11E389054C5A9A10000000000000000"),
    (20.4, "611E98A18172F392F162DF1DC04DB4F60B", "611E98A18172F392F10000000000000000"),
    (22.1, "74947D9503F8E98B1A00000005231502FE", "74947D9503F8E98B1A0000000000000000"),
    (24.1, "633C9337F9D6BB7028D5FDA160826BDBD1", "633C9337F9D6BB70280000000000000000"),
    (25.0, "5726AE3BAC550CE5B600000005D1A92EBA", "5726AE3BAC550CE5B60000000000000000"),
    (30.2, "5054306B8534BD21FD0CAAB9F42ADFD7D7", "5054306B8534BD21FD0000000000000000"),
    (40.8, "5ECC6C4875BAC032C6000000097F53A0A1", "5ECC6C4875BAC032C60000000000000000"),
    (41.2, "5103C48EC3B60824A103CFBA500EA2F62D", "5103C48EC3B60824A10000000000000000"),
    (41.9, "5117E03FDB30E43680CFA6FAAF546C9248", "5117E03FDB30E436800000000000000000"),
    (42.3, "4D7D9337CBC657D152FEDCDF1A20737F33", "4D7D9337CBC657D1520000000000000000"),
    (46.2, "51338E6C9C55209591C32656B0A1B5851C", "51338E6C9C552095910000000000000000"),
    (50.9, "5FD16BE55D9392ECAAB6B997E23C7BAA9C", "5FD16BE55D9392ECAA0000000000000000"),
    (54.6, "5AE97CB65E671504A9FFFFFFF34742D32D", "5AE97CB65E671504AA0000000000000000"),
    (58.4, "566BA29CF83279032534FDAEB493C01046", "566BA29CF8327903250000000000000000"),
    (58.4, "48FFDA42883B2439A3316431830EB9B85E", "48FFDA42883B2439A30000000000000000"),
    (61.5, "49774CA503C7A9547B03176EE9F4D82C23", "49774CA503C7A9547B0000000000000000"),
    (66.2, "64C9CF1872DA06EDF051BB3FFE440CAEEC", "64C9CF1872DA06EDF00000000000000000"),
    (73.6, "5A2F6C828329E92510E4AAE530FE14A92D", "5A2F6C828329E925100000000000000000"),
    (76.7, "4B85F1F99068DE58A2FFFFFFEE24700B4D", "4B85F1F99068DE58A30000000000000000"),
    (77.8, "5F2429A520890AF3BCFFFFFFEDE430C596", "5F2429A520890AF3BD0000000000000000"),
    (79.5, "46CFB2A4E1B3AB5F52C23C253ADAFBC36B", "46CFB2A4E1B3AB5F520000000000000000"),
    (81.3, "517CF6A45A0664E7A53BC25C895BD08789", "517CF6A45A0664E7A50000000000000000"),
    (86.5, "4EF62059C9BD4CC488D2BF9E2EC8E36D74", "4EF62059C9BD4CC4880000000000000000"),
    (88.2, "5A10ACFF496FA6774AB040127F4A6B9330", "5A10ACFF496FA6774A0000000000000000"),
    (89.2, "54D52FDF6BE9B90035F2B0A4B99D30ADB5", "54D52FDF6BE9B900350000000000000000"),
    (91.6, "5A4F97FF20B4C3A20B24972F6AB008FC2F", "5A4F97FF20B4C3A20B0000000000000000"),
    (94.1, "52E514D3B3F2E5153745C0427FA23CBF3D", "52E514D3B3F2E515370000000000000000"),
    (96.2, "61D7E0E664367C44F8B9A4D709050A1CB4", "61D7E0E664367C44F80000000000000000"),
    (100.6, "5F99544C718056C58C356F60CB31ECAC5D", "5F99544C718056C58C0000000000000000"),
    (102.0, "5AE4F0DEB76F520C778EC9583DECD03F1F", "5AE4F0DEB76F520C770000000000000000"),
    (112.5, "63F3A6E9A943C53C760000001A3193A3CA", "63F3A6E9A943C53C760000000000000000"),
    (114.6, "60E629F6CE12DA7770FCCFAF86B878DEEE", "60E629F6CE12DA77700000000000000000"),
    (118.6, "60BB631D9C88A5BFDCB3EDED1F370A0661", "60BB631D9C88A5BFDC0000000000000000"),
    (119.5, "56F5F1A4AA9A305691622D44A592312C70", "56F5F1A4AA9A3056910000000000000000"),
    (121.0, "6423ABB69FB07BCF2F90CBF216A4A70CA8", "6423ABB69FB07BCF2F0000000000000000"),
    (123.5, "54595F139E243AED430000001CC210ED4F", "54595F139E243AED430000000000000000"),
    (126.2, "54379650B9E6043884FFFFFFE29AF8B0B3", "54379650B9E60438850000000000000000"),
    (132.4, "53A99720C9908B984AFFFFFFE12BAE3592", "53A99720C9908B984B0000000000000000"),
    (133.8, "6147DA425A6C273D3BFFFFFFE0D96245E5", "6147DA425A6C273D3C0000000000000000"),
    (140.0, "52C77027651223997D9AA2BBA74448D585", "52C77027651223997D0000000000000000"),
    (151.6, "4C135FE24CF9B439135B93ADA4C48D484B", "4C135FE24CF9B439130000000000000000"),
    (153.3, "53C7B900953F332233FFFFFFDC4BCF65DA", "53C7B900953F3322340000000000000000"),
    (154.6, "5A1CBC4EBB47BB39CBFFFFFFDBFE75B73E", "5A1CBC4EBB47BB39CC0000000000000000"),
    (155.5, "5F3BB11C6C5826A99E2F76B78561BD8955", "5F3BB11C6C5826A99E0000000000000000"),
    (163.8, "59A6E000ECCF2E5972C2808371E3E33708", "59A6E000ECCF2E59720000000000000000"),
    (183.0, "6182A478AF0A1A1345250E1E0FB3138F77", "6182A478AF0A1A13450000000000000000"),
    (189.8, "4616074F8C4D3CD7AD0000002C30B1BDF3", "4616074F8C4D3CD7AD0000000000000000"),
    (196.1, "479233C1C453621A1CEC6DB44DE433F478", "479233C1C453621A1C0000000000000000"),
    (196.2, "505DCB592081A467775DACB6DD0CFBB15F", "505DCB592081A467770000000000000000"),
    (196.2, "65FB83D352894848070000002DAE4A322E", "65FB83D352894848070000000000000000"),
    (196.6, "60CFA1AFAD5D614AC192552088160AADE1", "60CFA1AFAD5D614AC10000000000000000"),
    (198.9, "53165BAEF85FBFE41988AB207A32C7F5AD", "53165BAEF85FBFE4190000000000000000"),
    (201.1, "4CF99DABB46C4863020000002ED128F1AB", "4CF99DABB46C4863020000000000000000"),
    (205.9, "5E32B258BECAD57066E5AD81A6641FB2A6", "5E32B258BECAD570660000000000000000"),
    (218.4, "4E74665A79264D1BAE7623DC54053A6045", "4E74665A79264D1BAE0000000000000000"),
]

# HIGH GAP DATA: k_est values with large gaps (for contrast)
# HIGH GAP DATA: k_est values with large gaps (for contrast)
HIGH_GAP = [
    (10006.7, "6D802D6F5431A9948200000919DBEEACED", "6D802D6F5431A994820000000000000000"),
    (669922.0, "7051056845BC94FFFFFFFD9EB5A2A35CB1", "7051056845BC9500000000000000000000"),
    (1024072.9, "5201CFE68A7EB9FFFFFFFC5C9C7251BA81", "5201CFE68A7EBA00000000000000000000"),
    (32940300000000000000, "4EDC8854AA6ED8CBCF21D2D252D431CBDA", "4C00000000000000000000000000000000"),
    (2312560000000000000000, "56047DA71615985FDBFE6663870F5119EE", "5400000000000000000000000000000000"),
    (13449600000000000000000000, "4392DDE5D90CEDD2B9DEB6C2518A71A082", "4000000000000000000000000000000000"),
    (59647200000000000000000000, "6DC4AEB356EAA44EB26541BDD09E6B9634", "6C00000000000000000000000000000000"),
    (69728800000000000000000000, "7CB5284E1533082CAEAC2C5BC9FB4AF683", "7C00000000000000000000000000000000"),
    (73075700000000000000000000, "50669CA52347754CEC1D7B190145969C16", "5000000000000000000000000000000000"),
    (101613000000000000000000000, "5EC9E96B645B674ACBA63A94F904B0725C", "5C00000000000000000000000000000000"),
    (132833000000000000000000000, "7B58AA7E0EDEF9F5BE4F22A78B7ADFEF24", "7800000000000000000000000000000000"),
]

# Constants
N = 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141
P = 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFC2F
RANGE_MIN = 0x4000000000000000000000000000000000
RANGE_MAX = 0x7FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF


@funsearch.run
def evaluate(seed: int) -> float:
  """Evaluate how well the hypothesis separates low-gap from high-gap k values."""
  import math
  
  low_scores = []
  for lgap, k_hex, start_hex in LOW_GAP:
    k = int(k_hex, 16)
    start = int(start_hex, 16)
    try:
      s = priority(k, start)
      if isinstance(s, (int, float)) and math.isfinite(s):
        low_scores.append(float(s))
      else:
        low_scores.append(0.0)
    except:
      low_scores.append(0.0)
  
  high_scores = []
  for lgap, k_hex, start_hex in HIGH_GAP:
    k = int(k_hex, 16)
    start = int(start_hex, 16)
    try:
      s = priority(k, start)
      if isinstance(s, (int, float)) and math.isfinite(s):
        high_scores.append(float(s))
      else:
        high_scores.append(0.0)
    except:
      high_scores.append(0.0)
  
  if not low_scores or not high_scores:
    return -1000.0
  
  avg_low = sum(low_scores) / len(low_scores)
  avg_high = sum(high_scores) / len(high_scores)
  
  # We want low-gap k's to score HIGHER than high-gap k's
  separation = avg_low - avg_high
  
  # Classification accuracy
  threshold = (avg_low + avg_high) / 2
  correct = sum(1 for s in low_scores if s > threshold)
  correct += sum(1 for s in high_scores if s <= threshold)
  accuracy = correct / (len(low_scores) + len(high_scores))
  
  return separation * 10 + accuracy * 100


@funsearch.evolve
def priority(k: int, start: int) -> float:
  """Score a k value. Higher score = more likely to produce low gap.

  Args:
    k: The k_est_unshifted value (135-bit integer)
    start: The chunk start position

  Available globals: N (curve order), P (field prime), RANGE_MIN, RANGE_MAX

  WHAT TO EXPLORE:
  - Why do these specific k values make tame kangaroos land near wild ones?
  - Is there structure in k mod N, k mod small primes?
  - Do low-gap k's have special bit patterns? Hex patterns?
  - Relationship between k and start (the chunk boundary)?
  - Smoothness, algebraic properties, quadratic residuosity?
  - Continued fractions, convergents of k/N or k/P?
  - Entropy, compressibility, information content?
  - Distance to special values (powers of 2, multiples of N)?
  - Periodicity, spectral properties, harmonics?
  - chunk_bits=64 have much lower lgaps than chunk_bits=130 ignore this fact and factor the range search width to get unified lgap
  - Anything else - this is open exploration!

  Returns:
    float: higher = more likely to be a low-gap k
  """
  # Baseline: just return 0 - LLM should discover the real pattern
  return 0.0